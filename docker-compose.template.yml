# Cloudways Developer Environment - Per-Developer Services Template
# Replace DEVELOPER with actual developer name (e.g., rahul, john)
# Replace *_BRANCH with actual branch names
#
# NOTE: Ansible API is shared across all developers (shared-ansible:5000)

version: '3.8'

networks:
  cw-shared:
    external: true

services:
  # ==========================================
  # Platform (cg-console-new) - Laravel 5.2
  # ==========================================
  DEVELOPER-platform:
    build:
      context: ./repos/cg-console-new
      dockerfile: docker/php/Dockerfile
    container_name: DEVELOPER-platform
    restart: unless-stopped
    working_dir: /var/www/html
    environment:
      # Application
      - APP_ENV=dev
      - APP_DEBUG=true
      - APP_KEY=base64:YOUR_APP_KEY_HERE
      
      # Git branch
      - GIT_BRANCH=PLATFORM_BRANCH
      
      # Database
      - DB_HOST=shared-mysql
      - DB_DATABASE=cw_DEVELOPER_platform
      - DB_USERNAME=root
      - DB_PASSWORD=root
      - DB_CONNECTION=mysql
      
      # Services (Ansible is shared)
      - APP_API_SERVER=http://DEVELOPER-middleware
      - APP_API_FLEXIBLE_SERVER=http://DEVELOPER-flexible
      - APP_ANSIBLE_HOST=http://shared-ansible:5000
      - APP_EVENT_SERVICE_HOST=http://DEVELOPER-events:3000
      - APP_COMM_SERVICE_HOST=http://DEVELOPER-comms
      
      # Redis
      - REDIS_HOST=shared-redis
      - REDIS_PORT=6379
      - REDIS_PREFIX=DEVELOPER:platform:
      
      # Mocking (enable for services not running)
      - APP_ANSIBLE_MOCKING=false
      - APP_API_SERVER_MOCKING=false
      - APP_COMMUNICATION_SERVICE_MOCKING=true
      - APP_FLEXIBLE_SERVER_MOCKING=false
      
      # Queue
      - QUEUE_DRIVER=redis
      - QUEUE_CONN=platform_queue
      
    volumes:
      - ./repos/cg-console-new:/var/www/html
      - ./keys:/root/.ssh:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.DEVELOPER-platform.rule=Host(`DEVELOPER.dev.cw.local`)"
      - "traefik.http.routers.DEVELOPER-platform.entrypoints=web"
      - "traefik.http.services.DEVELOPER-platform.loadbalancer.server.port=80"
    networks:
      - cw-shared
    depends_on:
      - DEVELOPER-middleware
      - DEVELOPER-flexible

  # ==========================================
  # Middleware (cg-apiserver) - CodeIgniter
  # ==========================================
  DEVELOPER-middleware:
    build:
      context: ./repos/cg-apiserver
      dockerfile: docker/php/Dockerfile
    container_name: DEVELOPER-middleware
    restart: unless-stopped
    working_dir: /var/www/html
    environment:
      # Git branch
      - GIT_BRANCH=MW_BRANCH
      
      # Database
      - DB_HOST=shared-mysql
      - DB_NAME=cw_DEVELOPER_middleware
      - DB_USER=root
      - DB_PASS=root
      
      # Services (Ansible is shared)
      - ANSIBLE_HOST=http://shared-ansible:5000
      - PLATFORM_URL=http://DEVELOPER-platform
      - EVENT_SERVICE_URL=http://DEVELOPER-events:3000
      
      # Queue (use db for local dev)
      - QUEUE_DRIVER=db
      
      # Environment
      - APP_ENV=dev
      
    volumes:
      - ./repos/cg-apiserver:/var/www/html
      - ./keys:/root/.ssh:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.DEVELOPER-middleware.rule=Host(`api-DEVELOPER.dev.cw.local`)"
      - "traefik.http.services.DEVELOPER-middleware.loadbalancer.server.port=80"
    networks:
      - cw-shared

  # ==========================================
  # Flexible Middleware - Laravel 10
  # ==========================================
  DEVELOPER-flexible:
    build:
      context: ./repos/flexible-middleware
      dockerfile: docker/runtimes/8.2/Dockerfile
    container_name: DEVELOPER-flexible
    restart: unless-stopped
    working_dir: /var/www/html
    environment:
      # Git branch
      - GIT_BRANCH=FLEXIBLE_BRANCH
      
      # Application
      - APP_ENV=dev
      - APP_DEBUG=true
      
      # Database
      - DB_HOST=shared-mysql
      - DB_DATABASE=cw_DEVELOPER_middleware
      - DB_USERNAME=root
      - DB_PASSWORD=root
      
      # Redis
      - REDIS_HOST=shared-redis
      - REDIS_PORT=6379
      - REDIS_PREFIX=DEVELOPER:flexible:
      
      # Services (Ansible is shared)
      - ANSIBLE_API_URL=http://shared-ansible:5000
      - PLATFORM_API_URL=http://DEVELOPER-platform
      - EVENT_SERVICE_URL=http://DEVELOPER-events:3000
      
    volumes:
      - ./repos/flexible-middleware:/var/www/html
      - ./keys:/root/.ssh:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.DEVELOPER-flexible.rule=Host(`flexible-DEVELOPER.dev.cw.local`)"
      - "traefik.http.services.DEVELOPER-flexible.loadbalancer.server.port=80"
    networks:
      - cw-shared

  # ==========================================
  # Flexible Operation Engine (FMOE) - Worker
  # ==========================================
  DEVELOPER-fmoe:
    build:
      context: ./repos/flexible-operation-engine
      dockerfile: docker/8.4/Dockerfile
    container_name: DEVELOPER-fmoe
    restart: unless-stopped
    working_dir: /var/www/html
    command: php artisan horizon
    environment:
      # Git branch
      - GIT_BRANCH=FMOE_BRANCH
      
      # Application
      - APP_ENV=dev
      - APP_DEBUG=true
      
      # Database
      - DB_HOST=shared-mysql
      - DB_DATABASE=cw_DEVELOPER_middleware
      - DB_USERNAME=root
      - DB_PASSWORD=root
      
      # Redis/Horizon
      - REDIS_HOST=shared-redis
      - REDIS_PORT=6379
      - HORIZON_PREFIX=DEVELOPER_horizon:
      
      # Services (Ansible is shared)
      - ANSIBLE_API_URL=http://shared-ansible:5000
      - MIDDLEWARE_URL=http://DEVELOPER-flexible
      
    volumes:
      - ./repos/flexible-operation-engine:/var/www/html
      - ./keys:/root/.ssh:ro
    networks:
      - cw-shared
    depends_on:
      - DEVELOPER-flexible

  # ==========================================
  # Event Service - Node.js
  # ==========================================
  DEVELOPER-events:
    build:
      context: ./repos/cg-event-service
      dockerfile: Dockerfile
    container_name: DEVELOPER-events
    restart: unless-stopped
    environment:
      # Git branch
      - GIT_BRANCH=EVENTS_BRANCH
      
      # PostgreSQL (Events DB)
      - POSTGRES_HOST=shared-postgres
      - POSTGRES_DB=cw_DEVELOPER_events
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      
      # Redis
      - REDIS_HOST=shared-redis
      - REDIS_PORT=6379
      
      # Node environment
      - NODE_ENV=development
      
    volumes:
      - ./repos/cg-event-service:/app
      - /app/node_modules
    networks:
      - cw-shared

  # ==========================================
  # Comms Service - Laravel/Lumen
  # ==========================================
  DEVELOPER-comms:
    build:
      context: ./repos/cg-comms-service
      dockerfile: docker/php/Dockerfile
    container_name: DEVELOPER-comms
    restart: unless-stopped
    environment:
      # Git branch
      - GIT_BRANCH=COMMS_BRANCH
      
      # Database
      - DB_HOST=shared-mysql
      - DB_DATABASE=cw_DEVELOPER_comms
      - DB_USERNAME=root
      - DB_PASSWORD=root
      
      # Redis
      - QUEUE_HOST=shared-redis
      - QUEUE_PORT=6379
      
      # Services
      - API_SERVER_URL=http://DEVELOPER-middleware
      - PLATFORM_URL=http://DEVELOPER-platform
      - EVENT_SERVICE_URL=http://DEVELOPER-events:3000
      
      # Environment
      - APP_ENV=dev
      - APP_DEBUG=true
      
    volumes:
      - ./repos/cg-comms-service:/var/www/html
      - ./keys:/root/.ssh:ro
    networks:
      - cw-shared

name: üöÄ Deploy ODS Frontend

on:
  workflow_dispatch:
    inputs:
      deployment_name:
        description: 'Deployment name (e.g., rahul-feature-123)'
        required: true
        type: string
      
      frontend_branch:
        description: 'platformui-frontend branch name'
        required: true
        default: 'master'
        type: string
      
      flexible_branch:
        description: 'flexible-ux3 branch name'
        required: true
        default: 'master'
        type: string
      
      fmp_branch:
        description: 'fmp-ux3 branch name'
        required: true
        default: 'master'
        type: string
      
      unified_branch:
        description: 'unified-design-system branch name'
        required: true
        default: 'master'
        type: string
      
      agencyos_branch:
        description: 'agencyos-ux3 branch name'
        required: true
        default: 'master'
        type: string
      
      guests_branch:
        description: 'guests-app-ux3 branch name'
        required: true
        default: 'master'
        type: string
      
      github_npm_token:
        description: 'GitHub NPM token for private packages (optional but recommended)'
        required: false
        type: string
      
      auto_destroy_days:
        description: 'Auto-destroy after (days)'
        required: true
        default: '7'
        type: choice
        options:
          - '1'
          - '3'
          - '7'
          - '14'
          - '30'
          - 'never'
      
      notify_completion:
        description: 'Send completion notification'
        required: true
        default: true
        type: boolean

jobs:
  validate:
    name: Validate Deployment Request
    runs-on: ubuntu-latest
    
    steps:
      - name: üîç Validate deployment name
        run: |
          if [[ ! "${{ inputs.deployment_name }}" =~ ^[a-z0-9-]+$ ]]; then
            echo "‚ùå Invalid deployment name. Use only lowercase, numbers, and hyphens."
            exit 1
          fi
          
          if [ ${#GITHUB_EVENT_INPUTS_DEPLOYMENT_NAME} -gt 50 ]; then
            echo "‚ùå Deployment name too long (max 50 characters)"
            exit 1
          fi
          
          echo "‚úÖ Deployment name is valid: ${{ inputs.deployment_name }}"
      
      - name: üìù Display deployment info
        run: |
          echo "## üöÄ Deployment Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment Name:** \`${{ inputs.deployment_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Owner:** \`${{ github.actor }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Auto-destroy:** ${{ inputs.auto_destroy_days }} days" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Branches" >> $GITHUB_STEP_SUMMARY
          echo "- **platformui-frontend:** \`${{ inputs.frontend_branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **flexible-ux3:** \`${{ inputs.flexible_branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **fmp-ux3:** \`${{ inputs.fmp_branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **unified-design-system:** \`${{ inputs.unified_branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **agencyos-ux3:** \`${{ inputs.agencyos_branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **guests-app-ux3:** \`${{ inputs.guests_branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Expected URL:** \`https://${{ inputs.deployment_name }}.ods.rahuljoshi.info\`" >> $GITHUB_STEP_SUMMARY

  deploy:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: validate
    timeout-minutes: 30
    
    steps:
      - name: üì• Checkout deployment scripts
        uses: actions/checkout@v4
        with:
          path: ods-deployments
      
      - name: üîê Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.DO_VPS_SSH_KEY }}
      
      - name: üîë Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.DO_VPS_HOST }} >> ~/.ssh/known_hosts
      
      - name: üì¶ Prepare deployment
        id: prepare
        run: |
          echo "deployment_url=https://${{ inputs.deployment_name }}.ods.rahuljoshi.info" >> $GITHUB_OUTPUT
          echo "timestamp=$(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
      
      - name: üì§ Copy deployment scripts to VPS
        run: |
          ssh ${{ secrets.DO_VPS_USER }}@${{ secrets.DO_VPS_HOST }} "mkdir -p /opt/ods-deployments"
          scp -r ods-deployments/* ${{ secrets.DO_VPS_USER }}@${{ secrets.DO_VPS_HOST }}:/opt/ods-deployments/
      
      - name: üöÄ Execute deployment on VPS
        id: deploy
        env:
          GITHUB_NPM_TOKEN: ${{ inputs.github_npm_token || secrets.GITHUB_NPM_TOKEN }}
        run: |
          ssh ${{ secrets.DO_VPS_USER }}@${{ secrets.DO_VPS_HOST }} << 'ENDSSH'
            set -e
            cd /opt/ods-deployments
            
            # Make scripts executable
            chmod +x scripts/*.sh
            
            # Export token for deployment script
            export GITHUB_NPM_TOKEN="${{ inputs.github_npm_token || secrets.GITHUB_NPM_TOKEN }}"
            
            # Run deployment with all branch parameters
            ./scripts/deploy-frontend.sh deploy \
              "${{ inputs.deployment_name }}" \
              "${{ inputs.frontend_branch }}" \
              "${{ github.actor }}" \
              "${{ inputs.auto_destroy_days }}" \
              "${{ inputs.flexible_branch }}" \
              "${{ inputs.fmp_branch }}" \
              "${{ inputs.unified_branch }}" \
              "${{ inputs.agencyos_branch }}" \
              "${{ inputs.guests_branch }}"
          ENDSSH
      
      - name: ‚úÖ Verify deployment
        run: |
          echo "‚è≥ Waiting for deployment to be ready..."
          sleep 30
          
          # Check if URL is accessible (with retries)
          for i in {1..10}; do
            if curl -f -s -o /dev/null -w "%{http_code}" "https://${{ inputs.deployment_name }}.ods.rahuljoshi.info" | grep -q "200\|301\|302"; then
              echo "‚úÖ Deployment is accessible!"
              break
            fi
            
            if [ $i -eq 10 ]; then
              echo "‚ö†Ô∏è  Deployment may take a few more minutes to be fully accessible"
            else
              echo "‚è≥ Attempt $i/10 - waiting 10 seconds..."
              sleep 10
            fi
          done
      
      - name: üìä Get deployment info
        id: info
        run: |
          ssh ${{ secrets.DO_VPS_USER }}@${{ secrets.DO_VPS_HOST }} << 'ENDSSH'
            cd /opt/ods-deployments
            ./scripts/deploy-frontend.sh list
          ENDSSH
      
      - name: üí¨ Post deployment summary
        run: |
          echo "## üéâ Deployment Successful!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**üåê URL:** https://${{ inputs.deployment_name }}.dev.cloudways.com" >> $GITHUB_STEP_SUMMARY
          echo "**üì¶ Deployment:** \`${{ inputs.deployment_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**üë§ Owner:** \`${{ github.actor }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**üåø Branch:** \`${{ inputs.frontend_branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**üîó API:** \`https://rj8-dev-ux.cloudways.services\`" >> $GITHUB_STEP_SUMMARY
          echo "**‚è∞ Auto-destroy:** ${{ inputs.auto_destroy_days }} days" >> $GITHUB_STEP_SUMMARY
          echo "**üìÖ Deployed:** ${{ steps.prepare.outputs.timestamp }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üéØ Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Open Frontend](https://${{ inputs.deployment_name }}.dev.cloudways.com)" >> $GITHUB_STEP_SUMMARY
          echo "- [Traefik Dashboard](https://traefik.dev.cloudways.com)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìù Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Test your features at the deployed URL" >> $GITHUB_STEP_SUMMARY
          echo "2. Check browser console for any errors" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify API calls to rj8-dev-ux.cloudways.services" >> $GITHUB_STEP_SUMMARY
      
      - name: üìß Send notification (optional)
        if: inputs.notify_completion == true
        run: |
          # This would integrate with your notification system
          echo "Deployment notification would be sent here"
          echo "URL: https://${{ inputs.deployment_name }}.dev.cloudways.com"
          echo "Owner: ${{ github.actor }}"

  on-failure:
    name: Handle Deployment Failure
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    
    steps:
      - name: üîç Collect failure logs
        run: |
          echo "## ‚ùå Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment:** \`${{ inputs.deployment_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ inputs.frontend_branch }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Owner:** \`${{ github.actor }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY
      
      - name: üßπ Cleanup failed deployment
        continue-on-error: true
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.DO_VPS_SSH_KEY }}
      
      - name: üóëÔ∏è Remove failed containers
        continue-on-error: true
        run: |
          ssh ${{ secrets.DO_VPS_USER }}@${{ secrets.DO_VPS_HOST }} << 'ENDSSH'
            cd /opt/ods-deployments
            ./scripts/deploy-frontend.sh destroy "${{ inputs.deployment_name }}" || true
          ENDSSH


version: '3.8'

services:
  frontend:
    container_name: ${DEV_NAME}-frontend
    build:
      context: .
      dockerfile: Dockerfile.dev
    image: ods-dev-frontend:latest
    restart: unless-stopped
    
    environment:
      - DEPLOYMENT_NAME=${DEV_NAME}
      - NODE_ENV=development
      - REACT_APP_ENV=development
    
    volumes:
      # Mount the entire repo so we have access to all packages
      - ${REPO_PATH}:/app:cached
      # Mount start script
      - ./start-dev-servers.sh:/start-dev-servers.sh:ro
    
    working_dir: /app
    
    # Run the start script
    command: bash /start-dev-servers.sh
    
    # Expose all dev server ports
    ports:
      - "8080" # unified-design-system
      - "8081" # container (main app)
      - "8082" # flexible
      - "8083" # fmp-ux3
      - "8084" # agencyos-ux3
      - "8085" # guests-app-ux3
    
    networks:
      - traefik-public
    
    labels:
      - "traefik.enable=true"
      
      # Main app router (container on port 8081)
      - "traefik.http.routers.${DEV_NAME}-fe.rule=Host(`${SUBDOMAIN}`)"
      - "traefik.http.routers.${DEV_NAME}-fe.entrypoints=websecure"
      - "traefik.http.routers.${DEV_NAME}-fe.tls.certresolver=letsencrypt"
      
      # Point to container app (main entry point)
      - "traefik.http.services.${DEV_NAME}-fe.loadbalancer.server.port=8081"
      
      # CORS and security headers
      - "traefik.http.middlewares.${DEV_NAME}-headers.headers.customresponseheaders.X-Frame-Options=SAMEORIGIN"
      - "traefik.http.middlewares.${DEV_NAME}-headers.headers.customresponseheaders.X-Content-Type-Options=nosniff"
      - "traefik.http.middlewares.${DEV_NAME}-headers.headers.accesscontrolallowmethods=GET,POST,PUT,DELETE,OPTIONS"
      - "traefik.http.middlewares.${DEV_NAME}-headers.headers.accesscontrolalloworigin=*"
      - "traefik.http.routers.${DEV_NAME}-fe.middlewares=${DEV_NAME}-headers"
      
      # Docker network
      - "traefik.docker.network=traefik-public"
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:8081/"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s  # Dev servers take longer to start

networks:
  traefik-public:
    name: traefik-public
    external: true

